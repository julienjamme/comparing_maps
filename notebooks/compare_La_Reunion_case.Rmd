----
title: "Using SpatialKWD package"
author: "Julien Jamme"
date: "2023-04-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = file.path(getwd(),".."))
```


## Objectives

- Learn how to use the functions within the `SpatialKWD` package
- How the KWD measure reacts to different kinds of compared maps
- How different from a standard measure is the KWD measure when comparing maps ?

- Learn about the time computation : How big can be the maps to compare them in a realistic time  ?
- L = 2/L=3/L=10 => how does this parameter influence the quality of the measure and the computation's time ?



```{r}
if(! "SpatialKWD" %in% installed.packages()[,1]) install.packages("SpatialKWD")

library(raster)
library(btb)
library(ggplot2)
library(purrr)
library(dplyr)
library(SpatialKWD)


source("R/functions.R", encoding = "UTF-8")
```

```{r}

```

```{r}
# download.file("https://www.insee.fr/fr/statistiques/fichier/6215140/Filosofi2017_carreaux_1km_gpkg.zip", "filo2017_1km_gpkg.zip")
reunion <- sf::st_read("data/Filosofi2017_carreaux_1km_reun.gpkg")
str(reunion)
```

```{r}
reunion_coords <- from_INSPIRE_to_xy(reunion$Idcar_1km, crs = "2975", res = "1000m")
str(reunion_coords)
```

```{r}
set.seed(1234)
reunion_df <- reunion %>% 
  sf::st_drop_geometry() %>% 
  dplyr::bind_cols(as.data.frame(reunion_coords)) %>% 
  dplyr::select(Idcar_1km, x,y,Ind,Men_pauv)

reunion_df_sm_2km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 2000) %>% 
  rename_with(~paste0(.,"_sm2km"), c("Ind","Men_pauv"))
reunion_df_sm_5km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 5000) %>% 
  rename_with(~paste0(.,"_sm5km"), c("Ind","Men_pauv"))
reunion_df_sm_10km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 10000, inspire = TRUE) %>% 
  rename_with(~paste0(.,"_sm10km"), c("Ind","Men_pauv"))

reunion_sf <- purrr::reduce(
  list(reunion_df_sm_2km, reunion_df_sm_5km[,-c(1:2)], reunion_df_sm_10km[,-c(1:2)]),
  sf::st_join,
) %>% full_join(
  reunion_df %>% dplyr::select(-x,-y) %>% 
    mutate(across(.cols = Ind:Men_pauv, ~sample(.), .names = "{.col}_perm")),
  by = c("idInspire" = "Idcar_1km")
  ) %>% 
  mutate(across(matches("(^Ind|^Men)", perl = TRUE), ~ifelse(is.na(.), 0, .))) %>% 
  dplyr::relocate(Ind, Men_pauv, .after = y)

reunion_sf %>% str()
```

## Working on a regional map 

```{r}
reunion_raster_Ind <- rasterFromXYZ(
  xyz = reunion_sf %>% sf::st_drop_geometry() %>% dplyr::select(x,y,starts_with("Ind")) %>% 
    arrange(x,y)
)
reunion_raster_Ind[is.na(reunion_raster_Ind)] <- 0
plot(reunion_raster_Ind)
```
Remark: typical case where the map is full of empty cells.


```{r}
kwd_reunion_ind <- compareOneToMany(
  reunion_raster_Ind %>% coordinates(), 
  reunion_raster_Ind %>% values(), 
  recode = TRUE
)
kwd_reunion_ind$distance
```


```{r}
hell_reunion_ind <- hellinger(
  reunion_raster_Ind %>% values()
)
hell_reunion_ind
```

```{r}
rmse_reunion_ind <- rmse(
  reunion_raster_Ind %>% values()
)
rmse_reunion_ind
```

## Working with a city map


```{r}
st_louis_centroide <- sf::st_as_sf(
  data.frame(x=c(333310,339601),y=c(7644145,7649149)), coords = c("x","y"), crs = 2975) %>% 
  sf::st_as_sfc()
dataGrid <- sf::st_make_grid(st_louis_centroide, cellsize = 1000, what = "centers") 
```



