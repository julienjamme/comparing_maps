----
title: "Comparing Maps: Some examples with the island of La RÃ©union"
author: "Julien Jamme"
date: "2023-04-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = file.path(getwd(),".."))
```


## Objectives

- How does the KWD measure react to different types of maps to compare ?
- How different from a standard measure is the KWD when comparing maps ?

```{r}
if(! "SpatialKWD" %in% installed.packages()[,1]) install.packages("SpatialKWD")

library(raster)
library(btb)
library(ggplot2)
library(purrr)
library(dplyr)
library(SpatialKWD)


source("R/functions.R", encoding = "UTF-8")
set.seed(1234)
```

```{r}
# download.file("https://www.insee.fr/fr/statistiques/fichier/6215140/Filosofi2017_carreaux_1km_gpkg.zip", "filo2017_1km_gpkg.zip")
reunion <- sf::st_read("data/Filosofi2017_carreaux_1km_reun.gpkg")
str(reunion)
```

```{r}
reunion_coords <- from_INSPIRE_to_xy(reunion$Idcar_1km, crs = "2975", res = "1000m")
str(reunion_coords)
```


## Smoothing data

To compute the smoothed values, we use the `btb` package that implements a smoothing function 
containing a side effect correction to take into account the presence of borders 
(separation between empty spaces et non-empty spaces). When the bandwidth becomes high, 
the correction is not perfect. The package is available on the Cran, presented 
[here](https://inseefr.github.io/btb/) and in the 
[Handbook of Spatial Analysis, chapter 8](https://www.insee.fr/en/information/3635545)

```{r}
reunion_df <- reunion %>% 
  sf::st_drop_geometry() %>% 
  dplyr::bind_cols(as.data.frame(reunion_coords)) %>% 
  dplyr::select(Idcar_1km, x,y,Ind,Men_pauv)

reunion_df_sm_2km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 2000) %>% 
  rename_with(~paste0(.,"_sm2km"), c("Ind","Men_pauv"))
reunion_df_sm_5km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 5000) %>% 
  rename_with(~paste0(.,"_sm5km"), c("Ind","Men_pauv"))
reunion_df_sm_10km <- reunion_df %>% dplyr::select(-1) %>% 
  btb::btb_smooth(sEPSG = "2975", iCellSize = 1000, iBandwidth = 10000, inspire = TRUE) %>% 
  rename_with(~paste0(.,"_sm10km"), c("Ind","Men_pauv"))

reunion_sf <- reunion_df_sm_2km %>% sf::st_drop_geometry() %>%  
  full_join(reunion_df_sm_5km %>% sf::st_drop_geometry(), by = c("x","y")) %>% 
  full_join(reunion_df_sm_10km, by = c("x","y")) %>% 
  sf::st_as_sf() %>% 
  full_join(
  reunion_df %>% dplyr::select(-x,-y) %>% 
    mutate(across(.cols = Ind:Men_pauv, ~sample(.), .names = "{.col}_perm")),
  by = c("idInspire" = "Idcar_1km")
  ) %>% 
  mutate(across(matches("(^Ind|^Men)", perl = TRUE), ~ifelse(is.na(.), 0, .)))%>% 
  dplyr::relocate(Ind, Men_pauv, .after = y)

plot(reunion_sf %>% sf::st_geometry())
summary(reunion_sf)
reunion_sf %>% str()
```

## Working on a regional map 

```{r}
reunion_raster_Ind <- rasterFromXYZ(
  xyz = reunion_sf %>% sf::st_drop_geometry() %>% dplyr::select(x,y,starts_with("Ind")) %>% 
    arrange(x,y)
)
reunion_raster_Ind[is.na(reunion_raster_Ind)] <- 0
plot(reunion_raster_Ind)
```
Remark: typical case where the map is full of empty cells. Here the empty cells 
are not contained in the data.


```{r}
(distances_reunion_Ind<- compare_distances(
  coordinates = reunion_sf %>% sf::st_drop_geometry() %>% dplyr::select(x,y),
  weights = reunion_sf %>% sf::st_drop_geometry() %>% dplyr::select(dplyr::starts_with("Ind"))
))
```

```{r}
distances_reunion_Ind %>%
  filter(map != "Ind_perm") %>% 
  filter(distance %in% c("kwd","Hellinger")) %>% 
  mutate(bw = as.numeric(gsub("\\D", "", map))) %>% 
  ggplot(aes(x=bw, y = val, color = distance)) +
  geom_line() +
  geom_point() +
  # scale_x_log10("sd (log-10 scale)") +
  # scale_y_log10("dist (log-10 scale)") +
  theme_minimal()
```


## Working with a city map


```{r}
st_louis_centroide <- sf::st_as_sf(
  # data.frame(x=c(333310,339601),y=c(7644145,7649149)), coords = c("x","y"), crs = 2975) %>% 
  data.frame(x=337100,y=7646600), coords = c("x","y"), crs = 2975) %>% 
  sf::st_as_sfc()

buffer <- sf::st_buffer(st_louis_centroide, dist = 10000,endCapStyle = "SQUARE")
```

```{r}
inter_buffer <- sf::st_within(
  reunion_sf, buffer
)
st_louis_area <- reunion_sf %>% filter(lengths(inter_buffer)>0)
nrow(st_louis_area)
```

```{r}
st_louis_raster_Ind <- rasterFromXYZ(
  xyz = st_louis_area %>% sf::st_drop_geometry() %>% dplyr::select(x,y,starts_with("Ind")) %>% 
    arrange(x,y)
)
st_louis_raster_Ind[is.na(st_louis_raster_Ind)] <- 0
plot(st_louis_raster_Ind)
```


```{r}
df_louis_area <- st_louis_area %>% sf::st_drop_geometry()

distances_st_louis <- compare_distances(
  coordinates = df_louis_area %>% dplyr::select(x,y),
  weights = df_louis_area %>% dplyr::select(dplyr::starts_with("Ind"))
)
```


```{r}
distances_reunion_Ind %>% rename(Island_val = val) %>% 
  full_join(
    distances_st_louis %>% rename(City_val = val)
  )
```


## Sensitivity to the grain of the information

Comparison while measuring distances from maps of 1km vs 200m grid.

